<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Deep Research Agent</title>
        <link
            rel="stylesheet"
            href="https://fonts.googleapis.com/css?family=Roboto:300,300italic,700,700italic"
        />
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.css"
        />
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/milligram/1.4.1/milligram.min.css"
        />
        <style>
            :root {
                /* Light theme */
                --bg-color: #fff;
                --text-color: #606c76;
                --heading-color: #606c76;
                --border-color: #d1d1d1;
                --input-bg: #fff;
                --input-border: #d1d1d1;
                --button-bg: #9b4dca;
                --button-hover: #606c76;
                --code-bg: #f4f5f6;
                --container-bg: #fff;
                --success-color: #27ae60;
                --warning-color: #f39c12;
                --error-color: #e74c3c;
            }

            [data-theme="dark"] {
                /* Dark theme */
                --bg-color: #1a1a1a;
                --text-color: #e0e0e0;
                --heading-color: #ffffff;
                --border-color: #404040;
                --input-bg: #2a2a2a;
                --input-border: #404040;
                --button-bg: #9b4dca;
                --button-hover: #8a3eb8;
                --code-bg: #2a2a2a;
                --container-bg: #1a1a1a;
            }

            body {
                background-color: var(--bg-color);
                color: var(--text-color);
                transition:
                    background-color 0.3s,
                    color 0.3s;
            }

            h1,
            h2,
            h3,
            h4,
            h5,
            h6 {
                color: var(--heading-color);
            }

            input,
            select,
            textarea {
                background-color: var(--input-bg);
                border-color: var(--input-border);
                color: var(--text-color);
            }

            input:focus,
            select:focus,
            textarea:focus {
                border-color: var(--button-bg);
            }

            fieldset {
                border-color: var(--border-color);
            }

            .button {
                background-color: var(--button-bg);
            }

            .button:hover {
                background-color: var(--button-hover);
            }

            .theme-toggle {
                position: fixed;
                top: 15px;
                right: 15px;
                background: transparent;
                border: 1px solid var(--border-color);
                border-radius: 3px;
                padding: 4px 8px;
                color: var(--text-color);
                cursor: pointer;
                font-size: 12px;
                font-family: inherit;
                line-height: 1;
                min-width: 40px;
                text-align: center;
                transition: all 0.3s;
                z-index: 1000;
            }

            .theme-toggle:hover {
                background: var(--code-bg);
                border-color: var(--button-bg);
            }

            #reportContent {
                background-color: var(--code-bg) !important;
                border-color: var(--border-color) !important;
                color: var(--text-color) !important;
            }

            .status-indicator {
                display: inline-flex;
                align-items: center;
                padding: 0.4rem 0.75rem;
                border-radius: 12px;
                font-size: 1rem;
                font-weight: 500;
                margin: 0.5rem 0;
                border: none;
                backdrop-filter: blur(8px);
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            }

            .status-indicator::before {
                content: "";
                width: 6px;
                height: 6px;
                border-radius: 50%;
                margin-right: 0.5rem;
                animation: pulse 2s infinite;
            }

            .status-connected {
                background: rgba(39, 174, 96, 0.15);
                color: var(--success-color);
                border: 1px solid rgba(39, 174, 96, 0.3);
            }

            .status-connected::before {
                background-color: var(--success-color);
            }

            .status-processing {
                background: rgba(243, 156, 18, 0.15);
                color: var(--warning-color);
                border: 1px solid rgba(243, 156, 18, 0.3);
            }

            .status-processing::before {
                background-color: var(--warning-color);
                animation: pulse 1s infinite;
            }

            .status-error {
                background: rgba(231, 76, 60, 0.15);
                color: var(--error-color);
                border: 1px solid rgba(231, 76, 60, 0.3);
            }

            .status-error::before {
                background-color: var(--error-color);
                animation: pulse 0.5s infinite;
            }

            .loading-indicator {
                display: none;
                text-align: center;
                margin: 2rem 0;
            }

            .spinner {
                display: inline-block;
                width: 40px;
                height: 40px;
                border: 3px solid var(--border-color);
                border-radius: 50%;
                border-top-color: var(--button-bg);
                animation: spin 1s ease-in-out infinite;
                margin-bottom: 1rem;
            }

            @keyframes spin {
                to {
                    transform: rotate(360deg);
                }
            }

            .timer {
                font-family: monospace;
                font-size: 1.2rem;
                color: var(--text-color);
                margin-top: 1rem;
            }

            .progress-steps {
                margin-top: 2rem;
                padding: 2rem;
                background: var(--code-bg);
                border-radius: 3px;
                border: 1px solid var(--border-color);
                display: flex;
                justify-content: space-between;
                align-items: flex-start;
                gap: 1rem;
                flex-wrap: wrap;
            }

            .step {
                display: flex;
                flex-direction: column;
                align-items: center;
                text-align: center;
                flex: 1;
                min-width: 120px;
                margin: 0.5rem;
            }

            .step-icon {
                width: 40px;
                height: 40px;
                border-radius: 50%;
                margin-bottom: 0.75rem;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 16px;
                font-weight: bold;
                color: white;
                transition: all 0.3s ease;
            }

            .step-text {
                font-size: 1rem;
                font-weight: 500;
                line-height: 1.3;
                color: var(--text-color);
            }

            .step-pending {
                background: var(--border-color);
            }

            .step-active {
                background: var(--warning-color);
                animation: pulse 2s infinite;
            }

            .step-completed {
                background: var(--success-color);
            }

            @keyframes pulse {
                0% {
                    opacity: 1;
                }
                50% {
                    opacity: 0.5;
                }
                100% {
                    opacity: 1;
                }
            }

            .cancel-button {
                margin-top: 1rem;
                background-color: var(--error-color) !important;
                border: 1px solid var(--error-color) !important;
                color: white !important;
            }

            .cancel-button:hover {
                background-color: #c0392b !important;
                border-color: #c0392b !important;
            }

            .cancel-button:focus {
                outline: 2px solid rgba(231, 76, 60, 0.3) !important;
                outline-offset: 2px !important;
                border: 1px solid var(--error-color) !important;
            }

            .depth-options {
                margin-top: 0.75rem;
                display: flex;
                flex-wrap: wrap;
                gap: 0.5rem;
            }

            .depth-option {
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 0.75rem 0.75rem;
                border: 1px solid var(--border-color);
                border-radius: 3px;
                cursor: pointer;
                transition: all 0.2s ease;
                background: var(--bg-color);
                flex: 1;
                min-width: 0;
                text-align: center;
            }

            .depth-option:hover {
                border-color: var(--button-bg);
                background: rgba(0, 123, 255, 0.05);
            }

            .depth-option input[type="radio"] {
                margin: 0 0.5rem 0 0;
                accent-color: var(--button-bg);
                vertical-align: middle;
            }

            .depth-option input[type="radio"]:checked + .depth-label {
                color: var(--button-bg);
                font-weight: 600;
            }

            .depth-option:has(input[type="radio"]:checked) {
                border-color: var(--button-bg);
                background: rgba(0, 123, 255, 0.1);
            }

            .depth-label {
                font-size: 1rem;
                color: var(--text-color);
                cursor: pointer;
                white-space: nowrap;
                line-height: 1;
                vertical-align: middle;
            }

            /* Responsive: stack on very small screens */
            @media (max-width: 600px) {
                .depth-options {
                    flex-direction: column;
                }
                .depth-option {
                    justify-content: flex-start;
                }
                .depth-label {
                    font-size: 1rem;
                }
            }

            .depth-options:has(input[type="radio"]:disabled) .depth-option {
                opacity: 0.6;
                cursor: not-allowed;
            }

            .depth-description {
                font-size: 1rem;
                color: var(--text-muted);
                margin-top: 0.5rem;
                margin-bottom: 1rem;
                font-style: italic;
            }
        </style>
    </head>
    <body>
        <!-- Theme Toggle Button -->
        <button class="theme-toggle" id="themeToggle" onclick="toggleTheme()">Dark</button>

        <div class="container">
            <!-- Header -->
            <div style="text-align: center; margin: 5rem 0">
                <h1>Deep Research Agent</h1>
                <p>Real-time research with AI agent</p>
                <div
                    id="sessionInfo"
                    style="font-size: 1.2rem; color: var(--text-color); margin-top: 1rem"
                >
                    Session: <span id="sessionId">Connecting...</span>
                </div>
            </div>

            <!-- Connection Status -->
            <div id="connectionStatus" class="status-indicator">
                <strong>Status:</strong> <span id="statusText">Disconnected</span>
            </div>

            <!-- Research Form -->
            <form id="researchForm">
                <fieldset>
                    <label for="researchTopic">Research Topic</label>
                    <input
                        type="text"
                        id="researchTopic"
                        name="researchTopic"
                        placeholder="e.g., Quantum computing applications in cryptography"
                        required
                        disabled
                    />

                    <div style="margin-top: 1rem">
                        <label>Research Depth</label>
                        <div class="depth-options" id="depthOptions">
                            <label class="depth-option">
                                <input type="radio" name="researchDepth" value="1" />
                                <span class="depth-label">1 - Quick Overview</span>
                            </label>
                            <label class="depth-option">
                                <input type="radio" name="researchDepth" value="2" checked />
                                <span class="depth-label">2 - Standard Research</span>
                            </label>
                            <label class="depth-option">
                                <input type="radio" name="researchDepth" value="3" />
                                <span class="depth-label">3 - Detailed Analysis</span>
                            </label>
                            <label class="depth-option">
                                <input type="radio" name="researchDepth" value="4" />
                                <span class="depth-label">4 - Comprehensive Study</span>
                            </label>
                            <label class="depth-option">
                                <input type="radio" name="researchDepth" value="5" />
                                <span class="depth-label">5 - Deep Dive</span>
                            </label>
                        </div>
                        <div class="depth-description" id="depthDescription">
                            Standard research with balanced depth and speed
                        </div>
                    </div>

                    <button type="submit" id="submitBtn" class="button-primary" disabled>
                        Start Research
                    </button>
                </fieldset>
            </form>

            <!-- Loading Indicator -->
            <div id="loadingIndicator" class="loading-indicator">
                <div class="spinner"></div>
                <h3>Researching your topic...</h3>
                <div class="timer" id="researchTimer">Time elapsed: 00:00</div>
                <button id="cancelBtn" class="button cancel-button">Cancel Research</button>

                <div class="progress-steps">
                    <div class="step">
                        <div class="step-icon step-pending" id="step1">1</div>
                        <div class="step-text">Generating search queries</div>
                    </div>
                    <div class="step">
                        <div class="step-icon step-pending" id="step2">2</div>
                        <div class="step-text">Performing deep research</div>
                    </div>
                    <div class="step">
                        <div class="step-icon step-pending" id="step3">3</div>
                        <div class="step-text">Analyzing insights</div>
                    </div>
                    <div class="step">
                        <div class="step-icon step-pending" id="step4">4</div>
                        <div class="step-text">Generating report</div>
                    </div>
                </div>
            </div>

            <!-- Results Container -->
            <div id="resultsContainer" style="display: none; margin-top: 3rem">
                <div
                    style="
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-bottom: 2rem;
                    "
                >
                    <h3>Research Results</h3>
                    <button id="downloadBtn" onclick="downloadMarkdown()" class="button">
                        Download Report
                    </button>
                </div>

                <div
                    id="reportContent"
                    style="
                        font-family: monospace;
                        white-space: pre-wrap;
                        background: var(--code-bg);
                        padding: 2rem;
                        border: 1px solid var(--border-color);
                        line-height: 1.6;
                    "
                >
                    <!-- Report content will be populated here -->
                </div>
            </div>
        </div>

        <script>
            /**
             * Deep Research Interface - WebSocket client for real-time research workflows
             *
             * This interface provides a user-friendly way to interact with the ResearcherAgent,
             * featuring real-time progress updates, cancellation capabilities, and result display.
             *
             * Key features:
             * - WebSocket connection with auto-reconnect
             * - Real-time progress indicator with timer
             * - Workflow cancellation support
             * - Markdown report rendering
             * - Theme switching (light/dark mode)
             */

            // Global state variables
            let ws = null; // WebSocket connection
            let currentReport = null; // Current research report content
            let currentTopic = null; // Current research topic
            let researchStartTime = null; // Research start timestamp
            let researchTimer = null; // Timer interval for elapsed time
            let currentWorkflowId = null; // Active workflow ID for cancellation

            // Initialize session ID from URL parameter or generate a unique one
            const urlParams = new URLSearchParams(window.location.search);
            const sessionId = urlParams.get("sessionId") || "research-" + Date.now();

            // Depth descriptions for user guidance
            const depthDescriptions = {
                1: "Quick overview with surface-level information (Fastest)",
                2: "Standard research with balanced depth and speed (Recommended)",
                3: "Detailed analysis with comprehensive insights (Thorough)",
                4: "Comprehensive study with extensive source exploration (Comprehensive)",
                5: "Deep dive with maximum research depth and analysis (Most thorough)",
            };

            // DOM elements
            const sessionIdElement = document.getElementById("sessionId");
            const connectionStatus = document.getElementById("connectionStatus");
            const statusText = document.getElementById("statusText");
            const researchForm = document.getElementById("researchForm");
            const researchTopic = document.getElementById("researchTopic");
            const depthOptions = document.getElementById("depthOptions");
            const depthDescription = document.getElementById("depthDescription");
            const submitBtn = document.getElementById("submitBtn");
            const resultsContainer = document.getElementById("resultsContainer");
            const reportContent = document.getElementById("reportContent");
            const loadingIndicator = document.getElementById("loadingIndicator");
            const researchTimerElement = document.getElementById("researchTimer");
            const cancelBtn = document.getElementById("cancelBtn");

            // Theme management
            function initializeTheme() {
                const savedTheme = localStorage.getItem("theme");
                const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
                const theme = savedTheme || (prefersDark ? "dark" : "light");
                setTheme(theme);
            }

            function setTheme(theme) {
                document.documentElement.setAttribute("data-theme", theme);
                const themeToggle = document.getElementById("themeToggle");
                if (themeToggle) {
                    themeToggle.textContent = theme === "dark" ? "Light" : "Dark";
                }
                localStorage.setItem("theme", theme);
            }

            function toggleTheme() {
                const currentTheme = document.documentElement.getAttribute("data-theme");
                const newTheme = currentTheme === "dark" ? "light" : "dark";
                setTheme(newTheme);
            }

            // Research timer functions
            function startResearchTimer() {
                // Only set start time if not already set (for new research vs resumed research)
                if (!researchStartTime) {
                    researchStartTime = Date.now();
                }

                researchTimer = setInterval(() => {
                    const elapsed = Date.now() - researchStartTime;
                    const minutes = Math.floor(elapsed / 60000);
                    const seconds = Math.floor((elapsed % 60000) / 1000);
                    const timeString = `${minutes.toString().padStart(2, "0")}:${seconds.toString().padStart(2, "0")}`;
                    researchTimerElement.textContent = `Time elapsed: ${timeString}`;
                }, 1000);
            }

            function stopResearchTimer() {
                if (researchTimer) {
                    clearInterval(researchTimer);
                    researchTimer = null;
                }
                // Reset start time for next research
                researchStartTime = null;
            }

            function showLoadingIndicator() {
                loadingIndicator.style.display = "block";
                resultsContainer.style.display = "none";
                resetProgressSteps();
                startResearchTimer();
            }

            function hideLoadingIndicator() {
                loadingIndicator.style.display = "none";
                stopResearchTimer();
            }

            function resetProgressSteps() {
                for (let i = 1; i <= 4; i++) {
                    const step = document.getElementById(`step${i}`);
                    step.className = "step-icon step-pending";
                }
            }

            function updateProgressStep(stepNumber, status = "active") {
                // Complete previous steps
                for (let i = 1; i < stepNumber; i++) {
                    const step = document.getElementById(`step${i}`);
                    step.className = "step-icon step-completed";
                }

                // Update current step
                const currentStep = document.getElementById(`step${stepNumber}`);
                currentStep.className = `step-icon step-${status}`;
            }

            // Update UI based on connection state
            function updateConnectionStatus(status, message) {
                statusText.textContent = message;
                connectionStatus.className = `status-indicator status-${status}`;

                const isConnected = status === "connected";
                researchTopic.disabled = !isConnected;

                // Enable/disable all radio buttons
                const radioButtons = document.querySelectorAll('input[name="researchDepth"]');
                radioButtons.forEach((radio) => {
                    radio.disabled = !isConnected;
                });

                submitBtn.disabled = !isConnected;

                if (isConnected) {
                    researchTopic.focus();
                }
            }

            /**
             * Cancels the currently running research workflow
             * Sends a cancel request to the agent and resets the UI state
             */
            function cancelResearch() {
                if (currentWorkflowId && ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(
                        JSON.stringify({
                            type: "cancel_request",
                            workflowId: currentWorkflowId,
                            timestamp: Date.now(),
                        }),
                    );

                    hideLoadingIndicator();
                    updateConnectionStatus("connected", "Research cancelled");
                    submitBtn.disabled = false;
                    submitBtn.textContent = "Start Research";
                    currentWorkflowId = null;
                }
            }

            /**
             * Establishes WebSocket connection to the ResearcherAgent
             * Handles connection events, message routing, and auto-reconnection
             */
            function connectToAgent() {
                const protocol = window.location.protocol === "https:" ? "wss:" : "ws:";
                const wsUrl = `${protocol}//${window.location.host}/api/agent?chatId=${encodeURIComponent(sessionId)}`;

                updateConnectionStatus("connecting", "Connecting to research agent...");

                try {
                    ws = new WebSocket(wsUrl);

                    ws.onopen = () => {
                        updateConnectionStatus("connected", "Connected - Ready for research");
                    };

                    ws.onmessage = (event) => {
                        try {
                            const data = JSON.parse(event.data);
                            console.log("Received:", data);

                            switch (data.type) {
                                case "connected":
                                    // Use the message from the server to show current status
                                    const status =
                                        data.status === "ready"
                                            ? "connected"
                                            : data.status === "completed"
                                              ? "connected"
                                              : "processing";
                                    updateConnectionStatus(status, data.message);

                                    // Restore topic and depth if available
                                    if (data.researchTopic) {
                                        researchTopic.value = data.researchTopic;
                                    }
                                    if (data.researchDepth) {
                                        setSelectedDepth(data.researchDepth);
                                    }

                                    // Handle different connection states
                                    if (data.status === "ready") {
                                        // Ready for new research
                                        submitBtn.disabled = false;
                                        submitBtn.textContent = "Start Research";
                                        hideLoadingIndicator();
                                        // Hide results if any were shown
                                        resultsContainer.style.display = "none";
                                    } else if (data.status === "completed") {
                                        // Completed workflow - expect results to come next
                                        submitBtn.disabled = false;
                                        submitBtn.textContent = "Start New Research";
                                        hideLoadingIndicator();
                                        // Results will be displayed when research_completed message arrives
                                    } else if (data.status === "failed") {
                                        // Failed workflow - expect error to come next
                                        submitBtn.disabled = false;
                                        submitBtn.textContent = "Start New Research";
                                        hideLoadingIndicator();
                                    } else {
                                        // Running or other status
                                        submitBtn.disabled = true;
                                        submitBtn.textContent = "Checking status...";
                                    }
                                    break;

                                case "research_started":
                                    updateConnectionStatus(
                                        "processing",
                                        `Researching: ${data.topic}`,
                                    );
                                    submitBtn.disabled = true;
                                    submitBtn.textContent = "Researching...";
                                    currentWorkflowId = data.workflowId; // Store workflow ID for cancellation

                                    // Restore topic and depth if available
                                    if (data.topic) {
                                        researchTopic.value = data.topic;
                                    }
                                    if (data.researchDepth) {
                                        setSelectedDepth(data.researchDepth);
                                    }

                                    // Use the start time from the server if available, otherwise use current time
                                    researchStartTime = data.startTime || Date.now();

                                    showLoadingIndicator();
                                    updateProgressStep(1);
                                    // Simulate progress steps during research
                                    setTimeout(() => updateProgressStep(2), 5000); // 5 seconds
                                    setTimeout(() => updateProgressStep(3), 50000); // 50 seconds (deep research)
                                    setTimeout(() => updateProgressStep(4), 30000); // 30 seconds (analysis)
                                    break;

                                case "research_completed":
                                    updateConnectionStatus("connected", "Research completed");
                                    hideLoadingIndicator();
                                    if (data.status === "completed") {
                                        // Complete all steps
                                        updateProgressStep(4, "completed");
                                        displayResults(data.topic, data.report, true); // Pass true to indicate this is a restored session
                                    }
                                    submitBtn.disabled = false;
                                    submitBtn.textContent = "Start New Research";
                                    // Don't clear the topic and depth - keep them for reference
                                    // Only clear when user actually starts new research
                                    break;

                                case "error":
                                    updateConnectionStatus("error", `Error: ${data.message}`);
                                    hideLoadingIndicator();
                                    submitBtn.disabled = false;
                                    submitBtn.textContent = "Start New Research";
                                    break;

                                default:
                                    console.log("Unknown message type:", data.type);
                            }
                        } catch (e) {
                            console.error("Failed to parse message:", e);
                        }
                    };

                    ws.onerror = (error) => {
                        console.error("WebSocket error:", error);
                        updateConnectionStatus("error", "Connection error - retrying...");
                        setTimeout(connectToAgent, 3000);
                    };

                    ws.onclose = () => {
                        updateConnectionStatus("error", "Disconnected - retrying...");
                        setTimeout(connectToAgent, 3000);
                    };
                } catch (error) {
                    console.error("Failed to connect:", error);
                    updateConnectionStatus("error", "Failed to connect - retrying...");
                    setTimeout(connectToAgent, 3000);
                }
            }

            // Handle depth radio button changes
            depthOptions.addEventListener("change", (e) => {
                if (e.target.type === "radio") {
                    console.log("Depth changed to:", e.target.value);
                    const selectedDepth = e.target.value;
                    depthDescription.textContent = depthDescriptions[selectedDepth];
                }
            });

            // Set the selected depth radio button and update description
            function setSelectedDepth(depth) {
                console.log("Setting depth to:", depth);
                const depthRadio = document.querySelector(
                    `input[name="researchDepth"][value="${depth}"]`,
                );
                if (depthRadio) {
                    depthRadio.checked = true;
                    // Update description
                    const selectedDepth = depth.toString();
                    if (depthDescriptions[selectedDepth]) {
                        depthDescription.textContent = depthDescriptions[selectedDepth];
                    }
                } else {
                    console.error("Could not find radio button for depth:", depth);
                }
            }

            // Initialize depth description on page load
            function initializeDepthDescription() {
                console.log("Initializing depth description");
                const selectedRadio = document.querySelector('input[name="researchDepth"]:checked');

                if (selectedRadio && depthDescription) {
                    const currentDepth = selectedRadio.value;
                    console.log("Current depth value:", currentDepth);
                    depthDescription.textContent = depthDescriptions[currentDepth];
                } else {
                    console.error("Missing selected radio or description element");
                }
            }

            // Handle form submission
            researchForm.addEventListener("submit", (e) => {
                e.preventDefault();

                const topic = researchTopic.value.trim();
                const selectedRadio = document.querySelector('input[name="researchDepth"]:checked');
                const depth = selectedRadio ? parseInt(selectedRadio.value) : 2;

                if (topic && ws && ws.readyState === WebSocket.OPEN) {
                    currentTopic = topic;

                    // Hide any previous results when starting new research
                    resultsContainer.style.display = "none";

                    // Remove restored session indicator if it exists
                    const existingIndicator = document.getElementById("restoredIndicator");
                    if (existingIndicator) {
                        existingIndicator.remove();
                    }

                    // Update button state immediately
                    submitBtn.disabled = true;
                    submitBtn.textContent = "Starting Research...";

                    // Send research request with depth
                    ws.send(
                        JSON.stringify({
                            type: "research_request",
                            topic: topic,
                            depth: depth,
                            timestamp: Date.now(),
                        }),
                    );
                }
            });

            // Handle cancel button
            cancelBtn.addEventListener("click", cancelResearch);

            // Display research results
            function displayResults(topic, report, isRestored = false) {
                currentReport = report;
                currentTopic = topic;

                reportContent.textContent = report;
                resultsContainer.style.display = "block";

                // Add restored session indicator
                if (isRestored) {
                    // Check if indicator already exists to avoid duplicates
                    let existingIndicator = document.getElementById("restoredIndicator");
                    if (!existingIndicator) {
                        const indicator = document.createElement("div");
                        indicator.id = "restoredIndicator";
                        indicator.style.cssText = `
                            background: rgba(39, 174, 96, 0.15);
                            color: var(--success-color);
                            border: 1px solid rgba(39, 174, 96, 0.3);
                            border-radius: 3px;
                            padding: 0.75rem;
                            margin-bottom: 1rem;
                            font-size: 0.9rem;
                            text-align: center;
                        `;
                        indicator.innerHTML = `<strong>Session Restored:</strong> Previous research results have been automatically restored`;

                        // Insert before the results container content
                        resultsContainer.insertBefore(indicator, resultsContainer.firstChild);
                    }

                    // Don't scroll for restored sessions - user is already at the top
                } else {
                    // Only scroll for fresh completions
                    resultsContainer.scrollIntoView({ behavior: "smooth" });
                }
            }

            // Download markdown report
            function downloadMarkdown() {
                if (!currentReport || !currentTopic) return;

                const fileName = `research-${currentTopic.replace(/[^a-zA-Z0-9]/g, "-").toLowerCase()}-${new Date().toISOString().split("T")[0]}.md`;
                const blob = new Blob([currentReport], { type: "text/markdown" });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            }

            // Initialize
            document.addEventListener("DOMContentLoaded", () => {
                console.log("Initializing Deep Research Agent");
                sessionIdElement.textContent = sessionId;
                initializeTheme();
                initializeDepthDescription();
                connectToAgent();
            });
        </script>
    </body>
</html>
